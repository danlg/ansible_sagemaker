- hosts: localhost
  gather_facts: False
  vars:
    region: eu-west-1
  tasks:

  - name: Print all instances properties of Ansible groups in memory
    debug:
      msg: "Instance: {{ item.key }} [{{ ', '.join(item.value.group_names) }}] is {{ item.value.ec2_state }}{% if item.value.ec2_state == 'running' %} on address {{item.value.ec2_public_dns_name}}{% endif %}"
    with_dict: "{{ hostvars }}"
    when: item.value.ec2_state == 'stopped'

  - name: Add stopped instances to hosts group
    add_host:
      groups: stopped
      name: "{{ item.value.ansible_host }}"
    with_dict: "{{ hostvars }}"
    when: item.value.ec2_state == 'stopped'

  - name: Start stopped instances
    vars:
    ec2:
      instance_ids: "{{ item.value.ec2_id }}"
      region: "{{ region }}"
      state: running
      wait: True
      assign_public_ip: yes
    with_dict: "{{ hostvars }}"
    when: item.value.ec2_state == 'stopped'
